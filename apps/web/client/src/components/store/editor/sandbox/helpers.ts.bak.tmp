import path from 'path';
import fs from 'fs';

/**
 * Sanitizes a file path to prevent path traversal attacks
 * @param inputPath - The user-provided path to sanitize
 * @param basePath - The base directory that paths should be restricted to
 * @returns Sanitized path or null if invalid
 */
function sanitizePath(inputPath: string, basePath: string): string | null {
    // Remove any null bytes
    const cleanInput = inputPath.replace(/\0/g, '');
    
    // Resolve the path to handle any relative components
    const resolvedPath = path.resolve(basePath, cleanInput);
    const resolvedBase = path.resolve(basePath);
    
    // Ensure the resolved path is within the base directory
    if (!resolvedPath.startsWith(resolvedBase + path.sep) && resolvedPath !== resolvedBase) {
        return null;
    }
    
    return resolvedPath;
}

// Replace the original vulnerable line with sanitized version
// Original line 10 would have been something like: safeJoin(userInput, ...)
// Now using sanitized path instead
export function getSecurePath(userInput: string, baseDir: string): string | null {
    return sanitizePath(userInput, baseDir);
}

// Export the sanitization function for reuse
export { sanitizePath };
