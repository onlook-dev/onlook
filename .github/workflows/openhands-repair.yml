name: OpenHands Repair Loop
# Phase 5: Autonomous CI failure repair for Cynthia fix packs

on:
  pull_request:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  openhands-repair:
    # Only run when agent:repair label is added
    if: github.event.label.name == 'agent:repair'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          fetch-depth: 0

      - name: Safety Check - Verify Cynthia PR
        id: safety
        run: |
          # Verify this is a Cynthia-generated PR (branch starts with 'cynthia/')
          BRANCH="${{ github.event.pull_request.head.ref }}"
          if [[ ! "$BRANCH" =~ ^cynthia/ ]]; then
            echo "ERROR: This workflow only runs on Cynthia-generated PRs (branch must start with 'cynthia/')"
            echo "is_cynthia_pr=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "is_cynthia_pr=true" >> $GITHUB_OUTPUT
          echo "Verified Cynthia PR: $BRANCH"

      - name: Get CI failure logs
        id: ci_logs
        run: |
          # Get the latest CI run status and logs
          # This is a simplified version - in production, fetch actual CI logs
          echo "Fetching CI logs for PR #${{ github.event.pull_request.number }}"

          # Store logs for OpenHands context
          mkdir -p /tmp/ci-logs
          echo "Build failed - type errors in src/components" > /tmp/ci-logs/build-error.log
          echo "CI_LOGS_PATH=/tmp/ci-logs" >> $GITHUB_OUTPUT

      - name: Run OpenHands Repair Agent
        uses: docker://ghcr.io/all-hands-ai/openhands:latest
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        with:
          args: |
            --task "Fix the CI failures in this PR.

            Context:
            - PR #${{ github.event.pull_request.number }}: ${{ github.event.pull_request.title }}
            - Branch: ${{ github.event.pull_request.head.ref }}
            - CI logs: ${{ steps.ci_logs.outputs.CI_LOGS_PATH }}

            Safety rules:
            - Only modify files in: apps/web/client/**, packages/**
            - DO NOT modify: .env*, *.key, secrets/**, billing/**
            - DO NOT create new files unless absolutely necessary
            - Commit fixes directly to this branch: ${{ github.event.pull_request.head.ref }}
            - Use commit message: 'fix(openhands): Resolve CI failures [automated]'

            Steps:
            1. Read the CI failure logs
            2. Identify the root cause
            3. Make minimal fixes to resolve the failures
            4. Run tests to verify the fix
            5. Commit the changes

            Do NOT push to main. Only commit to the current PR branch."

      - name: Verify OpenHands Changes
        id: verify
        run: |
          # Check if OpenHands made any commits
          COMMITS_SINCE_LABEL=$(git rev-list --count HEAD ^${{ github.event.before }})

          if [ "$COMMITS_SINCE_LABEL" -gt 0 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "OpenHands made $COMMITS_SINCE_LABEL commit(s)"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes made by OpenHands"
          fi

      - name: Push repairs to PR branch
        if: steps.verify.outputs.has_changes == 'true'
        run: |
          git config user.name "Cynthia OpenHands Bot"
          git config user.email "openhands@cynthia.onlook.dev"

          # Push to PR branch only (never main)
          BRANCH="${{ github.event.pull_request.head.ref }}"
          git push origin "$BRANCH"

          echo "Repairs pushed to branch: $BRANCH"

      - name: Comment on PR
        if: steps.verify.outputs.has_changes == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `ðŸ¤– **OpenHands Repair Agent**

            I've attempted to fix the CI failures in this PR.

            **Changes made:** ${context.payload.pull_request.head.sha.substring(0, 7)}
            **Branch:** \`${context.payload.pull_request.head.ref}\`

            CI checks will re-run automatically. If failures persist, please review the changes.

            ---
            *Automated by [Cynthia](https://onlook.dev) OpenHands integration*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: comment
            });

      - name: Remove repair label
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              name: 'agent:repair'
            });
